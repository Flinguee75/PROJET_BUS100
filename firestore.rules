rules_version = '2';

/**
 * Règles de sécurité Firestore - Production
 * Système de Transport Scolaire
 *
 * Règle générale: Backend décide, Firestore stocke
 * Accès basé sur les rôles (RBAC): admin, driver, parent
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // FONCTIONS HELPER
    // ========================================

    // Vérifie si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }

    function userDocPath() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    // Récupère les données utilisateur (avec cache pour éviter les appels multiples)
    function getUserData() {
      return (isAuthenticated() && exists(userDocPath()))
        ? get(userDocPath()).data
        : { role: 'none', isActive: false, schoolId: null };
    }

    // Vérifie si l'utilisateur est admin
    // IMPORTANT: Pour les listes, cette fonction ne doit pas utiliser get() si possible
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin' && getUserData().isActive == true;
    }

    // Vérifie si l'utilisateur est chauffeur
    function isDriver() {
      return isAuthenticated() && getUserData().role == 'driver' && getUserData().isActive == true;
    }

    // Vérifie si l'utilisateur est parent
    function isParent() {
      return isAuthenticated() && getUserData().role == 'parent' && getUserData().isActive == true;
    }

    // Vérifie si le chauffeur est assigné à ce bus
    function isAssignedDriver(busId) {
      return isDriver() && getUserData().busId == busId;
    }

    // Vérifie si le parent a un enfant assigné à ce bus
    // Note: Cette fonction suppose que le backend maintient un champ 'assignedBusIds'
    // dans le document user (parent) avec la liste des bus de ses enfants
    function isParentOfBus(busId) {
      return isParent() &&
        (getUserData().assignedBusIds != null && busId in getUserData().assignedBusIds);
    }

    // Vérifie si l'utilisateur appartient à la même école
    function isSameSchool(resourceSchoolId) {
      return isAuthenticated() && 
        getUserData().schoolId != null && 
        resourceSchoolId == getUserData().schoolId;
    }

    // ========================================
    // COLLECTION: schools (écoles)
    // ========================================
    match /schools/{schoolId} {
      // Admin: lecture/écriture complète
      // Utilisateurs: lecture uniquement leur école
      allow read: if isAdmin() || (isAuthenticated() && getUserData().schoolId != null && schoolId == getUserData().schoolId);
      allow write: if isAdmin();
    }

    // ========================================
    // COLLECTION: buses
    // ========================================
    match /buses/{busId} {
      // Admin: lecture/écriture complète (sans restriction)
      // Chauffeur: lecture uniquement son bus (si même école)
      // Parent: lecture bus assigné à son enfant (si même école)
      // Utilisateurs authentifiés: lecture si même école
      allow read: if isAdmin() || 
        (isAuthenticated() && resource.data.schoolId != null && resource.data.schoolId == getUserData().schoolId) ||
        (isAssignedDriver(busId) && resource.data.schoolId == getUserData().schoolId) ||
        (isParentOfBus(busId) && resource.data.schoolId == getUserData().schoolId);
      allow write: if isAdmin();
    }

    // ========================================
    // COLLECTION: gps_live (positions temps réel)
    // ========================================
    match /gps_live/{busId} {
      // Admin: lecture toutes positions (sans restriction)
      // Chauffeur: écriture pour son bus uniquement, lecture de son bus (si même école)
      // Parent: lecture bus de son enfant uniquement (si même école)
      // Utilisateurs authentifiés: lecture si même école
      allow read: if isAdmin() || 
        (isAuthenticated() && resource.data.schoolId != null && resource.data.schoolId == getUserData().schoolId) ||
        (isAssignedDriver(busId) && resource.data.schoolId == getUserData().schoolId) ||
        (isParentOfBus(busId) && resource.data.schoolId == getUserData().schoolId);
      allow write: if isAssignedDriver(busId) && resource.data.schoolId == getUserData().schoolId;
    }

    // ========================================
    // COLLECTION: gps_history (historique GPS)
    // ========================================
    match /gps_history/{busId}/{day}/{positionId} {
      // Admin: lecture tout l'historique
      // Chauffeur: lecture historique de son bus
      // Parent: lecture historique du bus de son enfant
      allow read: if isAdmin() || isAssignedDriver(busId) || isParentOfBus(busId);
      // Autoriser l'écriture aux chauffeurs de ce bus (création depuis l'app mobile) et aux admins
      allow create, update: if isAdmin() || isAssignedDriver(busId);
      allow delete: if isAdmin();
    }

    // ========================================
    // COLLECTION: students (élèves)
    // ========================================
    match /students/{studentId} {
      // Admin: lecture/écriture complète (sans restriction)
      // Parent: lecture uniquement ses enfants (si parentIds contient son uid)
      // Chauffeur: lecture élèves de son bus
      // Utilisateurs authentifiés: lecture si même école (via bus)
      allow read: if isAdmin() ||
        (isParent() && request.auth.uid in resource.data.parentIds) ||
        (isDriver() && resource.data.busId != null && resource.data.busId == getUserData().busId) ||
        (isAuthenticated() && resource.data.busId != null);
      allow write: if isAdmin();
    }

    // ========================================
    // COLLECTION: users (drivers, parents, admins)
    // ========================================
    match /users/{userId} {
      // Chaque utilisateur peut lire son propre profil
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Admin peut tout lire/écrire
      allow read, write: if isAdmin();
    }

    // ========================================
    // COLLECTION: notifications
    // ========================================
    match /notifications/{notificationId} {
      // Lecture si l'utilisateur est dans recipientIds
      allow read: if isAuthenticated() &&
        request.auth.uid in resource.data.recipientIds;
      // Écriture uniquement par admin ou backend
      allow write: if isAdmin();
    }

    // ========================================
    // COLLECTION: routes (parcours)
    // ========================================
    match /routes/{routeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ========================================
    // COLLECTION: attendance (présences)
    // ========================================
    match /attendance/{attendanceId} {
      // Admin: lecture/écriture complète
      // Chauffeur: lecture/écriture pour son bus
      // Utilisateurs authentifiés: lecture si même école
      allow read: if isAdmin() || 
        (isAuthenticated() && resource.data.busId != null);
      allow write: if isAdmin() || 
        (isDriver() && request.resource.data.busId == getUserData().busId);
    }

    // ========================================
    // COLLECTION: fcm_tokens (tokens push notifications)
    // ========================================
    match /fcm_tokens/{tokenId} {
      // Utilisateur peut gérer ses propres tokens
      allow read, write: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ========================================
    // COLLECTION: alerts_live (alertes temps réel)
    // ========================================
    match /alerts_live/{alertId} {
      // Admin: lecture/écriture complète
      // Utilisateurs authentifiés: lecture uniquement
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ========================================
    // COLLECTION: course_history (historique des courses)
    // ========================================
    match /course_history/{historyId} {
      allow read: if isAdmin() ||
        (isDriver() && resource.data.driverId == request.auth.uid);
      allow create: if isDriver() &&
        request.resource.data.driverId == request.auth.uid &&
        request.resource.data.busId == getUserData().busId;
      allow update: if isAdmin() ||
        (isDriver() && resource.data.driverId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // ========================================
    // DEFAULT: Bloquer tout le reste
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
